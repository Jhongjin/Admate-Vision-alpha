# 광고주 인식률 저하 원인 분석 및 개선 방향

---

## 0. 전수 조사: 개선 배포 후 전 샘플 미인식 회귀 (2026-02)

### 0.1 현상

- 이전: SSG만 인식됨.
- 개선 배포 후: **모든 샘플 이미지에서 광고주 미인식** (이전보다 결과 악화).

### 0.2 전수 조사 결과

| 항목 | 내용 | 결론 |
|------|------|------|
| **OCR** | PSM.SPARSE_TEXT(11) 설정 추가됨. 이 모드는 “흩어진 텍스트”용이라, **배너 전체가 텍스트인 이미지**에서는 영역 분할이 잘못되거나 추출 텍스트가 **비거나 극히 적어질 수 있음**. | **원인 1** |
| **OCR** | setParameters 호출이 브라우저 워커에서 예외를 일으키거나, recognize 전에 PSM이 리셋되는 등으로 **실제 인식 결과가 빈 문자열**이 될 수 있음. | **원인 2** |
| **매칭** | `matchOcrToAdvertiser` 단위 테스트 8건 모두 통과. 공백 정규화·임계값·confidence 계산은 **OCR 텍스트가 주어지면 정상 동작**. | **매칭 로직은 정상** |
| **데이터** | 더미 광고주 searchTerms 확장만으로는 “전부 미인식”을 설명하기 어렵고, **OCR 출력이 비어 있으면 매칭은 항상 null**. | **근본 원인은 OCR 출력** |

### 0.3 촬영 방향 (세로 vs 가로)

- **세로 촬영**: 인식률 소폭 개선.
- **가로 촬영**: 인식률 매우 낮음 (대부분 광고주 미인식). 원인: 가로로 찍을 때 광고 문구가 이미지 내에서 **회전**해 있으면 Tesseract가 텍스트 방향을 잘못 해석함.
- **조치**: Tesseract `recognize` 옵션에 **`rotateAuto: true`** 추가. 엔진이 방향을 감지해 이미지를 보정한 뒤 인식하므로, 가로 촬영·세로 배치 광고 등 회전된 텍스트에 대응.

### 0.4 결론 및 조치

- **근본 원인**: PSM.SPARSE_TEXT 적용으로 OCR 추출 텍스트가 **비거나 극히 적어짐** → 모든 이미지에서 매칭 실패.
- **조치**: OCR에서 **PSM 설정 제거**(기본 PSM 사용). 매칭 로직·searchTerms 확장·임계값 완화는 유지.
- **검증**: `src/features/capture/lib/match-advertiser.test.ts`로 매칭만 단위 테스트하여, OCR 텍스트가 주어질 때 SSG/VIP/aT/LG/충남/교육청/카카오뱅크 등 정상 매칭 확인.

---

## 1. 현상 (초기)

- **에스에스지(SSG)** 만 정상 인식되고, 나머지 광고주는 대부분 "광고주 미인식"으로 표시됨.
- 인식률이 매우 낮음.

---

## 2. 원인 분석

### 2.1 SSG만 인식되는 이유

- SSG 광고는 **영문 브랜드명 "SSG.COM", "SSG"** 가 크게 노출됨.
- Tesseract는 **영문(eng) 인식률이 한글(kor)보다 높은 편**이라, 짧은 영문 "SSG"가 안정적으로 추출됨.
- searchTerms에 "SSG", "SSG.COM", "에스에스지" 등이 있어 **영문만으로도 매칭** 가능.

### 2.2 한글/기타 광고주 미인식 원인

| 구분 | 원인 | 설명 |
|------|------|------|
| **OCR 품질** | 한글(kor) 인식률 상대적으로 낮음 | Tesseract 한글은 영문 대비 오인식·누락이 많음. 저해상도·기울기·폰트·반사 시 악화. |
| **OCR 품질** | 페이지 분할 모드(PSM) 부적합 | 기본 PSM이 문서 중심이라, 광고 배너처럼 텍스트가 흩어져 있는 레이아웃에선 영역 탐지가 어긋날 수 있음. |
| **매칭 로직** | 공백/띄어쓰기 차이 | OCR이 "서울 여자 대학교", "vip자산운용"(공백 없음) 등으로 추출하는데, searchTerms는 "서울여자대학교", "vip 자산운용"만 있어 **정규화만으로는 매칭 실패**. |
| **매칭 로직** | 신뢰도 임계값 과다 | `CONFIDENCE_THRESHOLD = 0.3`. confidence = (score / maxPossibleScore) * 1.2 인데, **짧은 키워드만 매칭되면 점수가 낮아짐**. 예: "aT"(2자)만 매칭 시 score=2, maxPossibleScore=12 → confidence ≈ 0.2 < 0.3 → 미인식 처리. |
| **매칭 로직** | confidence 계산식 | 한 광고주 내에 긴 키워드(한국농수산식품유통공사)와 짧은 키워드(aT)가 섞여 있으면, 짧은 키워드만 매칭돼도 maxPossibleScore가 커서 confidence가 낮게 나옴. |
| **searchTerms** | 변형·부분 표기 부족 | OCR이 "한국 농수산식품유통공사", "자산운용", "교육청", "혁신도시" 등 **공백 포함/부분 표기**로 읽을 수 있는데, 해당 변형이 searchTerms에 없음. |

### 2.3 정리

1. **OCR**: 한글 품질 한계 + PSM 기본값이 배너 레이아웃에 최적이 아님.
2. **매칭**: 공백 무시/정규화 부족, 임계값·confidence 공식이 짧은 키워드 매칭을 과도하게 탈락시킴.
3. **데이터**: searchTerms가 OCR에서 실제로 나올 수 있는 표기(공백 포함, 부분어, 영문 소문자 등)를 충분히 커버하지 못함.

---

## 3. 개선 방향 (현재 적용 범위)

### 3.1 매칭 로직 개선 (우선 적용)

- **정규화 강화**: 매칭 시 "공백 제거" 버전도 사용.  
  - OCR 텍스트·searchTerm 모두 `공백 제거 + 소문자` 로 한 번 더 비교 → "vip 자산운용" ↔ "vip자산운용" 등 매칭 가능.
- **신뢰도 임계값 조정**: 0.3 → 0.15 수준으로 완화하거나, "최소 1개 키워드 매칭 시 통과" 로직 추가.
- **confidence 계산 변경**:  
  - 짧은 키워드만 매칭돼도 과도하게 탈락하지 않도록,  
  - 예: 매칭된 키워드 중 **최대 길이 ≥ 2** 이면 최소 confidence를 0.5로 부여하거나,  
  - score를 "매칭된 키워드 수" 또는 "가장 긴 매칭 키워드 길이" 기반으로 보정.

### 3.2 더미 광고주 데이터 보강

- **공백 포함/제거 변형 추가**:  
  - "한국 농수산식품유통공사", "vip자산운용", "서울 여자 대학교", "충남 혁신도시" 등.
- **부분 키워드 추가**:  
  - "자산운용", "교육청", "보건안전진흥원", "혁신도시", "농수산", "LG", "엘지" 등 OCR이 자주 읽는 형태.
- **영문 소문자 변형**:  
  - "aT" → "at" (OCR이 소문자로 읽을 수 있음).

### 3.3 OCR 품질 개선 (선택)

- **PSM 설정**: `PSM.SPARSE_TEXT`(11)를 적용했을 때 **전 샘플 미인식 회귀**가 발생하여 **제거함**. 현재는 Tesseract 기본 PSM 사용. 다른 PSM(예: SINGLE_BLOCK) 시도 시에는 단위 테스트·샘플 이미지로 회귀 여부 확인 필요.
- **이미지 전처리**: 해상도 업스케일, 대비 강화, 이진화 등은 추후 단계에서 검토.

---

## 4. 미구현 (향후 검토)

- **광고주 미인식 시 → 광고주 등록 페이지로 이동하는 플로우**  
  - 현재는 더미 데이터 재확인 및 인식률 개선에만 초점.  
  - 추후: "광고주 미인식"일 때 "광고주 등록" 버튼/링크로 등록 페이지 이동 플로우 추가 예정.

---

## 5. 참고

- 기술 명세: `vooster-docs/capture-recognition-spec.md`
- 더미 광고주: `src/features/capture/data/dummy-advertisers.ts`
- OCR: `src/features/capture/lib/ocr.ts`
- 매칭: `src/features/capture/lib/match-advertiser.ts`
- 매칭 단위 테스트: `src/features/capture/lib/match-advertiser.test.ts`
