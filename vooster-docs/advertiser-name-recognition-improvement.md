# 유사/긴 광고주명 인식 개선

**목적**: "서울특별시교육청보건안전진흥", "서울여자대학교" 등 유사·긴 광고주명이 OCR 결과와 제대로 매칭되도록 로직을 보강하고, 향후 개선 방안을 정리한다.

---

## 1. 현상

- **역명/호선**은 이미지에서 인식되었으나, **PPT 노출량 보고서 포함** 체크박스가 역명/호선이 모두 있을 때만 보이도록 되어 있어, 일부 환경에서 체크박스가 보이지 않는 문제가 있었다. → **조건 완화**: 보고 발송 설정 카드에서는 역명/호선 여부와 무관하게 PPT 옵션을 항상 노출하도록 수정 완료.
- **광고주 인식**: "서울특별시교육청보건안전진흥", "서울여자대학교" 등 **긴 이름·유사 표기**가 OCR 텍스트에 있어도 매칭이 실패하거나 불안정한 경우가 있었다.

---

## 2. 원인 요약

| 구분 | 내용 |
|------|------|
| **검색어 부족** | DB `search_terms`가 비어 있거나 짧은 별칭만 있을 때, **광고주 전체 이름**이 검색어로 쓰이지 않으면 매칭 실패 가능. |
| **토큰 단위 매칭 한계** | OCR을 공백 기준 토큰으로만 나누어 유사도 비교할 때, "서울특별시교육청 보건안전진흥원"처럼 **띄어쓰기**로 나뉘면 전체 이름과 한 번에 비교되지 않음. |
| **끝글자 차이** | DB에는 "서울특별시교육청보건안전진흥"으로, OCR에는 "서울특별시교육청보건안전진흥**원**"으로 나오는 등 **일부 글자만 다를 때** 기존 fuzzy는 토큰 단위라 유사도가 낮게 나올 수 있음. |

---

## 3. 적용한 개선 사항

### 3.1 항상 광고주 이름을 검색어에 포함

- **위치**: `src/features/capture/lib/match-advertiser.ts`
- **내용**: 각 광고주의 `searchTerms`에 **광고주 이름(`advertiser.name`)을 항상 포함**하도록 함.  
  - API에서 `search_terms`가 비어 있으면 이름을 fallback으로 주는 부분은 그대로 두고, **매칭 단계에서도** 이름이 빠지지 않도록 보강.
- **효과**: "서울여자대학교"처럼 이름만 등록된 경우나, 검색어가 짧은 별칭 위주일 때도 **전체 이름**으로 한 번 더 비교되어 인식률이 올라감.

### 3.2 긴 검색어는 OCR 전체 문자열과도 유사도 비교

- **위치**: 동일 파일, `bestFuzzySimilarity` 함수.
- **내용**: 검색어(또는 광고주 이름) 길이가 **LONG_TERM_LENGTH(10자) 이상**이면, OCR **토큰**뿐 아니라 **OCR 전체 문자열**(공백 정규화·공백 제거 둘 다)과 Levenshtein 유사도를 계산해, 더 높은 쪽을 채택.
- **효과**: "서울특별시교육청보건안전진흥" vs "서울특별시교육청보건안전진흥원"처럼 **끝 한두 글자만 다르거나 띄어쓰기만 다른** 긴 이름도 매칭 가능성이 높아짐.

### 3.3 confidence 계산 시 사용하는 terms 통일

- **내용**: 최종 선택된 광고주에 대해 confidence를 계산할 때도, **실제로 매칭에 사용한 terms**(searchTerms + name)와 동일한 집합을 사용하도록 통일.
- **효과**: 이름만으로 매칭된 경우에도 confidence가 일관되게 계산됨.

### 3.4 동점 시 긴 정확일치 우선 (재테스트 반영)

- **내용**: combined 점수가 같을 때 **maxMatchedLen**(가장 긴 정확일치 길이)이 큰 쪽을 선택하고, 그마저 같으면 **maxFuzzySim**으로 비교.
- **효과**: OCR에 "서울특별시교육청보건안전진흥원"이 있을 때, "서울특별시교육청"(검색어에 보건안전진흥원 포함)이 "서울여자대학교"(짧은 토큰만 매칭)보다 우선 선택되도록 함.

### 3.5 PPT 메뉴 노출·가시성 (재테스트 반영)

- **위치**: `src/app/(protected)/capture/confirm/page.tsx`
- **내용**:
  - 보고 발송 설정 카드는 **matchedAdvertiserId**뿐 아니라 **advertiserLabel**이 있어도 노출 (`matchedAdvertiserId || advertiserLabel != null`).
  - PPT 노출량 보고서 블록에 `border-t-2`, `bg-slate-50/80`, `rounded-lg`, 체크박스/라벨에 `text-gray-900` 등으로 **배경·텍스트 대비**를 높여 눈에 띄게 표시. `data-report-ppt-section` 속성으로 디버깅 가능.
- **효과**: 인식 광고주가 표시되면 PPT 옵션이 누락 없이 보이고, 색상으로 인해 안 보이는 문제를 줄임.

---

## 4. 코드 상수

| 상수 | 값 | 의미 |
|------|----|------|
| `MIN_FUZZY_TERM_LENGTH` | 4 | 이 길이 미만의 검색어는 fuzzy 미적용 (LG 등 오인식 방지). |
| `LONG_TERM_LENGTH` | 10 | 이 길이 이상이면 OCR 전체 문자열과도 유사도 비교. |
| `CONFIDENCE_THRESHOLD` | 0.2 | 이 이상이면 인식 성공으로 간주. |

---

## 5. 향후 검토 방안

1. **검색어 자동 보강**  
   - 광고주 등록/수정 시 `search_terms`가 비어 있으면 **이름을 자동으로 한 항목 추가**하는 것은 백엔드에서 이미 수행 중.  
   - 필요 시 "서울여자대학교" → "서울여대", "서울 여자 대학교" 같은 **동의어/띄어쓰기 변형**을 자동 생성해 search_terms에 넣는 규칙을 검토할 수 있음.

2. **부분 문자열(Substring) 가중치**  
   - OCR 텍스트가 광고주 이름을 **포함**하는 경우(예: OCR에 "서울특별시교육청보건안전진흥원" 있고 DB에는 "서울특별시교육청") 추가 가산을 주는 방식은 현재 `exactContains`로 이미 반영됨.  
   - 반대로 **이름이 OCR 일부를 포함**하는 경우(DB "서울특별시교육청보건안전진흥원", OCR "서울특별시교육청보건안전진흥")는 이번에 추가한 **긴 검색어 ↔ OCR 전체 유사도**로 보완됨.

3. **OCR 품질 개선**  
   - 긴 한글 이름의 인식률은 **OCR 품질**에 크게 좌우됨.  
   - `vooster-docs/ocr-fundamental-survey.md`, `recognition-rate-analysis.md` 등에 정리된 대로 **CLOVA OCR, Upstage 등** 서버 OCR 도입 시 인식률 추가 개선 기대.

4. **테스트 데이터**  
   - `match-advertiser.test.ts`에 "서울특별시교육청보건안전진흥원", "서울여자대학교" 등 **실제 유사 케이스**를 추가해 회귀 방지하는 것을 권장.

5. **운영 DB에 광고주 등록 (서울특별시교육청보건안전진흥원 오인식 방지)**  
   - 촬영 확인 화면의 광고주 목록은 **Supabase `advertisers` 테이블**에서 오므로, "서울특별시교육청보건안전진흥원" 광고물이 "서울여자대학교"로 잘못 인식되면 **서울특별시교육청(또는 보건안전진흥원)이 DB에 없거나 검색어가 부족한 경우**일 수 있음.  
   - **조치**: 광고주 관리에서 **서울특별시교육청보건안전진흥원**을 등록하고, `search_terms`가 비어 있어도 **이름이 항상 검색어로 사용**되므로 OCR에 "서울특별시교육청보건안전진흥원"이 있으면 해당 행이 매칭됨. 필요 시 검색어에 `건강한 서울 학교`, `보건안전진흥원` 등을 추가하면 더 안정적.

---

## 6. 역명 오인식 차단 (배포에줘 등)

- **현상**: 역명판 OCR 결과에 사용자 요청 문구("배포에줘", "배포해줘" 등)가 섞여 역명으로 표시되는 문제.
- **조치**: `src/features/capture/lib/station-from-ocr.ts`에 **역명으로 쓰이면 안 되는 문구 블록리스트** 추가. 해당 문구가 추출되면 `stationName`을 null로 반환해 "역명 미인식"으로 표시.
- **추가**: 역번호(예: 529) **바로 뒤**에 나오는 한글을 역명 후보로 우선 사용해, 역명판 형식("529 공덕")에서 더 안정적으로 역명 추출.

---

## 7. 관련 파일

- `src/features/capture/lib/station-from-ocr.ts` — 역명·호선 추출, 역명 오인식 블록리스트
- `src/features/capture/lib/match-advertiser.ts` — 매칭·유사도 로직
- `src/features/advertisers/backend/service.ts` — `rowToResponse`에서 search_terms 비었을 때 이름 fallback
- `vooster-docs/ocr-advertiser-matching-tech-review.md` — OCR–광고주 매칭 기술 검토
- `vooster-docs/ocr-fundamental-survey.md` — OCR 정확도 근본 개선 조사
