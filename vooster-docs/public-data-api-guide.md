# 공공데이터 API 활용 가이드 (노출량·PPT 보고용)

노출량 산정 및 PPT 보고서 생성을 위해 **역별·시간대별 승하차/유동인구** 데이터가 필요할 때 참고하는 가이드입니다.

---

## 0. 어떤 게 가장 좋을까? / 신청 리스트

### 추천 우선순위 (역별·시간대별 노출량용)

| 순위 | 출처 | 이유 |
|------|------|------|
| **1** | **공공데이터포털 – 서울교통공사_역별승하차인원** | REST API, 자동승인, 개발 1만 건/일, 역명·통행일자·통행시간·승하차 인원 제공. 우리 서비스(역+호선+게재기간)와 바로 연동 가능. |
| 2 | 서울 열린데이터광장 | 역별·시간대별 데이터 적합하나 일 1,000건 제한. 활용사례 등록 후 해제 가능. |
| 3 | 철도통계포털(KRIC) | 연·월 단위 집계 위주라 **역별·시간대별**에는 불리. 보조 참고용. |

**정리**: 노출량·PPT용이면 **공공데이터포털 1개 API만 먼저 신청**해도 충분합니다.

### 신청해야 할 리스트 (체크리스트)

- [ ] **1. 공공데이터포털 회원가입**  
  - [data.go.kr](https://www.data.go.kr) 접속 → 회원가입

- [ ] **2. 서울교통공사_역별승하차인원 API 활용신청**  
  - 공공데이터포털에서 "서울교통공사 역별승하차인원" 또는 "역별 승하차" 검색  
  - 해당 Open API 상세 페이지에서 **「활용신청」** 클릭  
  - 개발/운영 단계 모두 **자동승인**인 경우가 많음

- [ ] **3. 인증키(Service Key) 확인**  
  - 마이페이지 → 인증키 관리에서 **발급된 키** 복사  
  - 서버(Vercel 등) 환경 변수에 **`DATA_GO_KR_SERVICE_KEY`** 로 저장 (클라이언트 노출 금지)

- [ ] **4. (선택) 서울 열린데이터광장**  
  - 일 1,000건으로 부족할 때만 [data.seoul.go.kr](https://data.seoul.go.kr) 가입 후 Open API 인증키 신청  
  - 환경 변수: **`SEOUL_OPEN_DATA_API_KEY`**

- [ ] **5. (선택) LLM API**  
  - 보고서에 **자연어 요약/맞춤 문구/다국어**를 넣을 때만 OpenAI/Claude/CLOVA 등 신청  
  - 노출량 숫자 + PPT 템플릿만 쓰면 **신청 불필요**

---

## 1. 공공데이터포털 (data.go.kr)

### 1.1 신청 절차

1. **회원가입**: [공공데이터포털](https://www.data.go.kr) 접속 후 회원가입
2. **활용신청**: 원하는 데이터 페이지에서 **「활용신청」** 클릭
3. **승인**: 개발/운영 단계 모두 **자동승인**인 경우가 많음

### 1.2 두 API 비교 (역별승하차 vs 역별 요일별 환승)

**보고 목표**: 게재 기간 → 요일별·시간대별 유동인구 → 해당 기간 예상 노출량

| 구분 | **역별승하차인원** (API 1) | **역별 요일별 환승인원** (API 2) |
|------|---------------------------|----------------------------------|
| **데이터 범위** | **승차 + 하차** = 역을 이용하는 **전체** (유동인구에 가까움) | **환승인원만** = 역을 지나는 사람 중 **일부** |
| **노출량 적합성** | ✅ 광고 노출 대상(역 이용 전원)과 잘 맞음 | ❌ 환승만 쓰면 노출량 **과소 추정** |
| **요일별** | 통행일자로 **요일 집계 가능** (API 문서 확인) | ✅ **요일별** 명시 제공 |
| **시간대별** | 통행시간 필드로 **시간대 집계 가능** (API 문서 확인) | ❌ 시간대 명시 없음 |
| **포맷** | JSON, XML | XML만 |

**결론**: **역별승하차인원(API 1)** 이 더 적합합니다.  
- 노출량 = “해당 역을 이용한 사람 수”에 비례하므로 **승·하차 인원**이 맞고, 환승만 쓰면 실제보다 적게 나옵니다.  
- 요일별·시간대별은 API 1에서 **통행일자·통행시간**으로 집계하면 됩니다.  
- API 2(요일별 환승)는 **보조**로만 쓰고, 메인은 API 1로 두는 것을 권장합니다.

### 1.3 추천 API (지하철 역별 승하차)

| 데이터명 | 설명 | 비고 |
|----------|------|------|
| **서울교통공사_역별승하차인원** | 서울 지하철 역사별 승·하차 인원, 통행일자·통행시간·역명·역코드 등 | REST API, **최근 1주일**만 제공, 매일 갱신. **노출량용 1순위** |
| **역별 일별시간대별 승하차인원** | 시간대별 세분화 | 파일데이터 또는 OpenAPI 변환 제공 |

- **트래픽**: 개발 10,000건/일 등 (데이터별 상이)
- **요청 형식**: REST API (JSON/XML), URL에 **인증키(Service Key)** 필수

### 1.4 인증키 사용 예시

- 환경 변수 예: `DATA_GO_KR_SERVICE_KEY=발급받은인증키`
- 요청 URL 예:  
  `https://apis.data.go.kr/.../...?serviceKey={인증키}&역명=올림픽공원&...`
- **주의**: 인증키를 클라이언트에 노출하지 말고, **서버(API 라우트)** 에서만 사용

### 1.5 역별승하차인원 API 연동 (발급 완료 후)

**환경 변수 (Vercel/서버)**

| 변수 | 필수 | 설명 |
|------|------|------|
| `DATA_GO_KR_SERVICE_KEY` | ✅ | 발급받은 인증키. 설정 시 실제 API 호출 시도. |
| `DATA_GO_KR_STATION_FLOW_ENDPOINT` | 선택 | API **기본 URL**(쿼리 없이). 미설정 시 **목 데이터** 사용. |

**엔드포인트 URL 확인**

1. [공공데이터포털 → 서울교통공사_역별승하차인원](https://www.data.go.kr/data/15143845/openapi.do) 접속
2. **Open API 활용가이드** 또는 **상세기능**에서 **요청 URL** 확인 (예: `https://apis.data.go.kr/1234567890/xxx/getStationBoardAlight`)
3. **쿼리 파라미터 제외한 base URL**을 `DATA_GO_KR_STATION_FLOW_ENDPOINT`에 설정  
   - 예: `https://apis.data.go.kr/1234567890/StationBoardAlight/getStationBoardAlight`

**우리 서비스에서 보내는 파라미터**

- `serviceKey` = `DATA_GO_KR_SERVICE_KEY`
- `type` = `json`
- `pageNo` = `1`, `numOfRows` = `500`
- `통행일자` = 전일 YYYYMMDD (API는 최근 1주일만 제공)
- `역명` = 조회 역명 (정규화된 값)

실제 API가 **한글 파라미터명**이 아니라 **영문**(예: `stnNm`, `trnsDt`)을 쓰면, `public-data-service.ts`의 `params`를 API 명세에 맞게 수정해야 합니다. Swagger/가이드에서 파라미터명 확인 후 필요 시 코드 수정.

**응답 처리**

- 응답의 `response.body.items.item`(배열 또는 단일 객체)에서 **통행시간·승차인원·하차인원**(또는 영문 필드)을 읽어 **일평균·시간대별**로 집계 후 노출량 계산에 사용합니다.

### 1.6 역/호선 매핑

- 공공 API는 **역코드** 또는 **역명**으로 조회하는 경우가 많음.
- 촬영 시 저장하는 **역명·호선**(예: "올림픽공원", "5호선")과 데이터의 **역 ID/명칭**이 다를 수 있으므로, **매핑 테이블**(JSON 또는 DB)을 두고 정규화 후 조회하는 것을 권장.

---

## 2. 서울 열린데이터광장 (data.seoul.go.kr)

### 2.1 인증키 발급

1. [서울 열린데이터광장](https://data.seoul.go.kr) 접속
2. 회원 로그인 후 **Open API 인증키 신청**
3. **인증키 관리** 메뉴에서 발급된 키 확인

### 2.2 사용 제한

- **일 1,000건** 등 호출 제한이 있을 수 있음.
- **활용사례(갤러리) 등록** 후 심사 승인 시 제한 해제 가능 (웹은 실제 접속 가능 URL 필요).

### 2.3 API URL 형식

- 기본:  
  `http://openapi.seoul.go.kr:8088/{인증키}/{요청파일타입}/{서비스명}/{시작인덱스}/{끝인덱스}`
- 환경 변수 예: `SEOUL_OPEN_DATA_API_KEY=발급받은인증키`

---

## 3. 철도통계포털 (KRIC, data.kric.go.kr)

- **도시철도 여객수송** 등 **연도·월별** 집계 위주.
- **역별·시간대별** 세분화가 필요한 경우 공공데이터포털·서울 열린데이터가 더 적합할 수 있음.
- CSV/파일 다운로드 위주이면, **정기 다운로드 → DB/캐시 적재** 후 우리 서비스에서 조회하는 방식 검토.

---

## 4. LLM API가 필요한 경우

현재 **노출량 계산 + PPT 자동 생성**은 **공공데이터(숫자) + 고정 템플릿**만으로 구현 가능합니다.  
**별도 LLM API는 필수는 아닙니다.**

다만 아래와 같은 **선택 기능**을 넣을 때 LLM이 유용합니다.

| 용도 | 설명 | LLM 활용 예 |
|------|------|-------------|
| **보고서 요약/설명 문구** | 노출량 숫자만이 아니라 "해당 역은 출퇴근 시간대 유동인구가 많아 …" 같은 **자연어 요약** | GPT/Claude 등으로 1~2문단 생성 후 PPT 슬라이드에 삽입 |
| **맞춤 인사말·결론** | 광고주/캠페인별로 다른 **맞춤 문구** | 프롬프트에 광고주명·역명·노출량 넣고 문단 생성 |
| **다국어 보고서** | 동일 내용의 **영문/기타 언어** 버전 | LLM으로 번역 또는 요약 생성 후 PPT 텍스트로 사용 |

### 4.1 LLM API 도입 시 참고

- **OpenAI API**, **Anthropic Claude**, **Naver CLOVA** 등 중 하나 선택.
- **환경 변수**: 예) `OPENAI_API_KEY`, `ANTHROPIC_API_KEY` — 서버에만 설정.
- **비용**: 토큰당 과금이므로, 보고서 1건당 1~2회 호출 수준으로 제한하는 것이 좋음.
- **구현 위치**: PPT 생성 직전에 “요약 문구 생성” 단계를 두고, 생성된 텍스트를 pptxgenjs 등으로 슬라이드에 넣으면 됨.

**정리**: Phase 2~4 기본 구현에는 **LLM 없이** 공공데이터 + 수식(유동인구×기간) + pptxgenjs로 진행 가능하고, **자연어 요약/맞춤 문구/다국어**를 넣을 때만 LLM API를 추가하면 됩니다.
